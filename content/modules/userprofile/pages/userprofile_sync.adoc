:idprefix:
:idseparator: -
:icons: font
:quick-uri: https://asciidoctor.org/docs/asciidoc-syntax-quick-reference/
ifndef::env-site,env-github[]
:toc: left
:toclevels: 3
endif::[]

toc::[]

== Introduction
Couchbase Sync Gateway is a key component of the Couchbase Mobile stack. It is an Internet-facing synchronization mechanism that securely syncs data across devices as well as between devices and the cloud.
It provides
* Data Synchronization across devices and the cloud
* Authorization & Access Control
* Data Validation

A Sync Gateway is configured using a link:https://developer.couchbase.com/documentation/mobile/2.0/guides/sync-gateway/config-properties/index.html[Sync Configuration File] that specifies it's run-time behavior. 

This tutorial will walk through a simple swift app that will demonstrate

* how to use the Sync Gateway (in walrus mode) to sync content between multiple Couchbase Lite enabled clients. This will cover the basics of the Sync Gateway Configuration and `Sync Function API`
* how to configure your Couchbase Lite clients for replication
* how to set up Live Queries within your Couchbase Lite clients so they are asyncronously notified of changes

====
You can learn more about the Sync Gateway https://developer.couchbase.com/documentation/mobile/2.0/guides/sync-gateway/index.html[here]
====

== Prerequisites
This tutorial assumes familiarity with building swift apps with Xcode and with Couchbase Lite.

* If you are unfamiliar with the basics of Couchbase Lite, it is recommended that you walk through the following tutorials
+
** link:https://developer.couchbase.com/documentation/mobile/2.0/userprofile_basic.html[Fundamentals] of using Couchbase Lite 2.0 as a standalone database
** link:https://developer.couchbase.com/documentation/mobile/2.0/userprofile_basic.html[Query Basics] with a prebuilt version of Couchbase Lite database

* iOS (Xcode 9.3+) 
  Download latest version from the link:https://itunes.apple.com/us/app/xcode/id497799835?mt=12[Mac App Store]
                        
* git (Optional)
This is required if you would prefer to pull the source code from GitHub repo.
** Create a link:https://github.com[free github account] if you don't already have one
** git can be downloaded from link:https://git-scm.com/book/en/v2/Getting-Started-Installing-Git[git-scm.org]

== System Overview
We will be working with a simple "User Profile" app. The version of the app extends the version introduced in the link:https://developer.couchbase.com/documentation/mobile/2.0/userprofile_basic.html[Query tutorial].

The app does the following 

* Allows users to log in and create or update his/her user profile information. The user profile view is _automatically_ updated everytime the profile information changes
* The user profile information is synced with a remote Sync Gateway which syncs it to other apps (subject to conditions specified in the `sync function`)


image::https://raw.githubusercontent.com/couchbaselabs/userprofile-couchbase-mobile/standalone/content/modules/userprofile/assets/images/university_app_overview.gif[App with Sync]

== App Installation

=== Fetching App Source Code

==== Option 1 : Git Clone

- Clone the *_query_* branch of the `User Profile Demo` project from GitHub. Type the following command in your terminal
+
[source,bash] 
----
  git clone -b query https://github.com/couchbaselabs/userprofile-couchbase-mobile.git
----

==== Option 2 : Download .zip

- Download the  `User Profile Demo` project from link:https://github.com/couchbaselabs/userprofile-couchbase-mobile/archive/sync.zip[here]

=== Installing Couchbase Lite Framework

- Next, we will download the Couchbase Lite 2.0 framework. The Couchbase Lite iOS framework is link:https://developer.couchbase.com/documentation/mobile/2.0/couchbase-lite/swift.html[distributed] via Cocoapods, Carthage or you can download the pre-built framework. In our example, we will be downloading the pre-built version of the framework. For this, do the following
+
[source,bash] 
----
  cd /path/to/UserProfileDemo/content/modules/userprofile/examples

  sh install_9.sh
----

Now, let's verify the installation

=== Try it Out
* Open the `UserProfileDemo.xcodeproj`. The project would be located at `/path/to/UserProfileDemo/content/modules/userprofile/examples`
+
[source,bash]
----
open UserProfileDemo.xcodeproj
----
+
* Build and run the project using the _simulator_ in Xcode. While you can run the app on a real device, we recommend the Simulator so you can see the debug logs in the output console.
* Verify that you see the login screen
+
image::user_profile_login.png[User Profile Login Screen Image]

== Sync Gateway 2.0 Installation
There are several link:https://developer.couchbase.com/documentation/mobile/2.0/installation/sync-gateway/index.html[deployment] options for the Sync Gateway. In our tutorial, we will be installing the Sync Gateway installer on the same _localhost_ as the mobile app

=== Download the Installer
* Download the Sync Gateway 2.0.0 installer from link:https://www.couchbase.com/downloads#couchbase-mobile[Downloads] page. Be sure to select the *"Mobile"* tab.

* Launch the Sync Gateway with the *sync-gateway-config-userprofile-walrus.json* config file that is bundled with the User Profile mobile App that you installed as per instructions in <<Fetching App Source Code>> section. The `sync-gateway-config-userprofile-walrus.json` will be located in the `/path/to/UserProfileDemo/content/modules/userprofile/examples/` folder 
+
[source,bash]
----
cd  /path/to/sync-gateway-installation/couchbase-sync-gateway/bin

./sync_gateway /path/to/UserProfileDemo/content/modules/userprofile/examples/sync-gateway-config-userprofile-walrus.json
----
+
* You should see a bunch of logs output to the console, similar to one below. For brevity, some of the log messages have been trimmed from output below
+
[source,bash]
----
~/couchbase-sync-gateway/bin | => ./sync_gateway ~/projects/ios/UserProfileDemo/content/modules/userprofile/examples/sync-gateway-config-userprofile-walrus.json 
2018-05-07T15:25:02.924-04:00 Enabling logging: [*]
2018-05-07T15:25:02.924-04:00 ==== Couchbase Sync Gateway/2.0.0(832;2d8a6c0) ====
2018-05-07T15:25:03.028-04:00     Created user "demo@example.com"
2018-05-07T15:25:03.028-04:00 Starting admin server on 127.0.0.1:4985
2018-05-07T15:25:03.028-04:00 Changes+: Notifying that "userprofile" changed (keys="{_sync:user:demo@example.com}") count=2
2018-05-07T15:25:03.028-04:00 Cache: Received #1 ("_user/demo@example.com")
2018-05-07T15:25:03.028-04:00 Cache: Initialized cache for channel "*" with options: &{ChannelCacheMinLength:50 ChannelCacheMaxLength:500 ChannelCacheAge:1m0s}
2018-05-07T15:25:03.028-04:00 Cache:     #1 ==> channel "*"
2018-05-07T15:25:03.028-04:00 Changes+: Notifying that "userprofile" changed (keys="{*}") count=3
2018-05-07T15:25:03.031-04:00 Starting server on :4984 ...

----

Now, let's verify the installation

=== Try it Out
* Open a browser and enter `http://localhost:4984` in the address bar
* You should see a message similar one below
+
[source,bash]
----
{"couchdb":"Welcome","vendor":{"name":"Couchbase Sync Gateway","version":"2.0"},"version":"Couchbase Sync Gateway/2.0.0(832;2d8a6c0)"}
----


== Data Model
If have followed along the tutorial on link:[Query Basics], you can skip this section and procees to <<Sync Gateway Configuration File>>. We have not made any changes to the Data model for this tutorial.
Couchbase Lite is a JSON Document Store. A Document is a logical collection of named fields and values.The values are any valid JSON types. In addition to the standard JSON types, Couchbase Lite supports some special types like `Date` and `Blob`.
While it is not required or enforced, it is a recommended practice to include a _"type"_ property that can serve as a namespace for related. 

=== The "User Profile" Document
The app deals with a single Document with a _"type"_ property of _"user"_.  The document ID is of the form _"user::<email>"_.
An example of a document would be 

```json
{
    "type":"user",
    "name":"Jane Doe",
    "email":"jame.doe@earth.org",
    "address":"101 Main Street",
    "image":CBLBlob (image/jpg),
    "university":"Rensselaer Polytechnic"
}
```

=== UserRecord 

The _"user"_ Document is encoded to a native struct named _UserRecord_.

[source,swift]
----
include::{examplesdir}/UserProfileDemo/model/UserRecord.swift[tags=userrecord]
----

== The "University" Document
The app comes bundled with a collection of Documents of type _"university"_. Each Document represents a university.


```json
{
    "type":"university","web_pages": [
      "http://www.rpi.edu/"
    ],
    "name": "Rensselaer Polytechnic Institute",
    "alpha_two_code": "US",
    "state-province": null,
    "domains": [
      "rpi.edu"
    ],
    "country": "United States"
}
```

=== UniversityRecord 

The _"university"_ Document is encoded to a native struct named _UniversityRecord_.

[source,swift]
----
include::{examplesdir}/UserProfileDemo/model/UserRecord.swift[tags=universityrecord]
----

== Sync Gateway Configuration File
The Sync Gateway Configuration File determines the run time behavior of the Sync Gateway.

* Open the `*sync-gateway-config-userprofile-walrus.json*` file using any text editor of your choice. The `sync-gateway-config-userprofile-walrus.json` is located in the app bundle at `/path/to/UserProfileDemo/content/modules/userprofile/examples`

* The *user* setting. 
+
For simplicity, we have hardcoded the user that we will be using in our system to be _"demo@example.com"_ with a password of _"password"_. In a production app, you can dynamically configure the user on the Sync Gateway through the link:https://developer.couchbase.com/documentation/mobile/2.0/references/sync-gateway/admin-rest-api/index.html#/user/post__db___user_[User Admin REST API]. If you want to want to use a different user, then add the credentials of that user to the config file and restart the Sync Gateway. 
+
[source,json]
----
"userprofile": {
      "users": { "demo@example.com": { "password": "password"} },
      ....
}
----

 * The *walrus* mode
 In a production deployment, the Sync Gatway should be backed up by a C

== Using a Prebuilt Database
There are several reasons why you may want to bundle your app with a prebuilt database. This would be suited for data that does not change or change that often, so you can avoid the bandwidth and latency involved in fetching/syncing this data from a remote server. This also improves the overall user experience by reducing the start-up time.

In our app, the instance of Couchbase Lite that holds the pre-loaded _"university"_ data is separate from the Couchbase Lite instance that holds _"user"_ data hold the pre-loaded data.  A separate Couchbase Lite instance is not required. However, in our case, since there can be many users potentially using the app on a given device,  it makes more sense to keep it separate. This is to avoid duplication of pre-loaded data for every user.

=== Location of the cblite file
The pre-built database will be in the form of a `cblite` file. It should be copied into you app project bundle
* In the `UserProfileDemo.xcodeproj` project explorer, locate the `universities.cblite2` file
+
image::cblite_location.png[Prebuilt Database Location]


=== Loading the Prebuilt Database
* Open the *DatabaseManager.swift* file and locate the `openPrebuiltDatabase()` function. The prebuilt database is common to all users of the app (on the device). So it will be loaded once and shared by all users on the device.
+
[source,swift]
----
include::{examplesdir}/UserProfileDemo/model/DatabaseManager.swift[tags=openPrebuiltDatabase]
----

* First, we create an instance of `DatabaseConfiguration` object and specify the path where the database would be located
+
[source,swift]
----
include::{examplesdir}/UserProfileDemo/model/DatabaseManager.swift[tags=dbconfig]
----

* Then we determine if the database "universities" already exists at the specified location. It would not be present if this is the first time we are using the app, in which case, we locate the _"universities.cblite"_ resource in the App's main bundle and we copy it over to the Database folder.  
If the database is already present at the specified Database location, we simply open the database.
+ 
[source,swift]
----
include::{examplesdir}/UserProfileDemo/model/DatabaseManager.swift[tags=prebuiltdbopen]
----

=== Closing the Database
When a user logs out, we close the Prebuilt Database along with other user-specific databases

* Open the *DatabaseManager.swift* file and locate the `closePrebuiltDatabase()` function. 
+
[source,swift]
----
include::{examplesdir}/UserProfileDemo/model/DatabaseManager.swift[tags=closePrebuiltDatabase]
----

* Closing the database is pretty straightforward
+
[source,swift]
----
include::{examplesdir}/UserProfileDemo/model/DatabaseManager.swift[tags=dbclose]
----

=== Try It Out
* The app should be running in the simulator
* Log into the app with any email Id and password. Let's use the values _"demo@example.com"_ and _"password"_ for user Id and password fields respectively. If this is the first time that _any_ user is signing in to the app, the pre-built database will be loaded from the App Bundle. In addition, new user-specific Database will be created / opened.
* Confirm that the console log output has a message similar to the one below. In my example, I am logging in with a user email Id of _"demo@example.com"_.
+
[source,bash]
----
Will open Prebuilt DB  at path /Users/priya.rajagopal/Library/Developer/CoreSimulator/Devices/E4E62394-9940-4AF8-92FC-41E3C794B216/data/Containers/Data/Application/A9425551-7F52-461D-B4F5-CC04315154D6/Library/Application Support

2018-05-04 17:04:16.319360-0400 UserProfileDemo[54115:13479070] CouchbaseLite/2.0.0 (Swift; iOS 11.3; iPhone) Build/806 Commit/2f2a2097+CHANGES LiteCore/2.0.0 (806)

2018-05-04 17:04:16.319721-0400 UserProfileDemo[54115:13479070] CouchbaseLite minimum log level is Verbose
Will open/create DB  at path /Users/priya.rajagopal/Library/Developer/CoreSimulator/Devices/E4E62394-9940-4AF8-92FC-41E3C794B216/data/Containers/Data/Application/A9425551-7F52-461D-B4F5-CC04315154D6/Library/Application Support/demo@example.com
---- 
* The above log message indicate the location of the Prebuilt database as well as the Database for the user. This would be within the _Application Support_ folder.
* Open the folder in your Finder app and verify that a Database with name _"univerities"_ exists along with a user specific Database with name _"userprofile"_
+
image::db_locations.png[Database Locations]

== Exploring the Query API
The Query API in Couchbase Lite 2.0 is extensive. In our app, we will be using the `QueryBuilder` API to make a simple _pattern matching_ query using the `like` Query Expression. 

=== Fetching University Document
Once the user logs in, the user is taken to the "Your Profile" screen. When the user taps on the "University" cell, a search screen is displayed where the user can enter the search criteria (name and optionally, the location) for the university. When the search criteria is entered, the local _"universities"_ Database is queried for <<The "University" Document>> documents that match the specified search criteria. 

* Open the *UniversityPresenter.swift* file and locate the `fetchUniversityRecords()` function.
+
[source,swift]
----
include::{examplesdir}/UserProfileDemo/presenter/UniversityPresenter.swift[tags=fetchUniversityRecords]
----

* We build the Query using the `QueryBuilder` API that will look for Documents that match the specified criteria.
+
[source,swift]
----
include::{examplesdir}/UserProfileDemo/presenter/UniversityPresenter.swift[tags=buildquery]
----
<1> Build a `QueryExpression` that uses the `like` operator to look for the specified _"name"_ string in the _"name"_ property. Notice couple of things here - (a) The use of *wildcard "%" operator* to denote that we are looking for the presence of the string anywhere in the _"name"_ property and (b) The use of `Function.lowercase()` to convert the search string into lowercase equivalent. Since `like` operator does _case-senstive matching_, we convert the search string and the property value to lowercase equivalents and compare the two.
<2> If the location criteria was specified in the search, then Build a `QueryExpression` that uses the `like` operator to look for the specified _"location"_ string in the _"location"_ property.
<3> The `SelectResult.all()` specifiees that we are interested in all properties in Documents that match the specified criteria
<4> The `DataSource.database(db)` specified the Data Source
<5> We include the `where` clause that is the logical ANDing of the QueryExpression in <1> and <2>


* We run the Query by calling the `execute()` method on the Query that was constructed in the previous step
+
[source,swift]
----
include::{examplesdir}/UserProfileDemo/presenter/UniversityPresenter.swift[tags=runquery]
----
<1> Create an instance of <<UniversityRecord>> type
<1> Use specific type getters to fetch property values. These <<UniversityRecord>> instance is populated with these property values.
<2> Getters also available for `array` types. This returns a Couchbase Lite `ArrayObject` type. So you would have to use `toArray()` to convert the Couchbase Lite native array equivalent.

=== Try It Out
* You should have followed the steps discussed in the "Try It Out" section under <<Loading the Prebuilt Database>>
* Tap on "University" table cell
* You should see a screen show that allows you enter the search criteria for the university
* Enter "Harv" for name . You can optionally enter "united states" for location
* Confirm that you see a list of universities that match the criteria
+
image::https://raw.githubusercontent.com/couchbaselabs/userprofile-couchbase-mobile/standalone/content/modules/userprofile/assets/images/university_list.gif[University List]
+
* Select a university 
* Press "Done" button
* Confirm that the university you selected shows up in the University table cell
+
image::https://raw.githubusercontent.com/couchbaselabs/userprofile-couchbase-mobile/standalone/content/modules/userprofile/assets/images/university_selection.gif[University Selection]
+
* You can optionally fill in other entries in the User Profile screen
* Tap "Done" button
* Confirm that you see an alert message "Succesfully Updated Profile". The Document will be updated this time.
* Tap "Log Off" and log out of the app
* Log back into the app with the same user email Id and password that you used earlier. In my example, I used _"demo@example.com"_ and _"password"_. So I will log in with those credentials again.
* Confirm that you see the profile screen  with the _university_ value that you set earlier. 
+
image::https://raw.githubusercontent.com/couchbaselabs/userprofile-couchbase-mobile/standalone/content/modules/userprofile/assets/images/profile_update.gif[Log Off and Log Back On]

== Learn More
Congratulations on completing this tutorial!

This tutorial walked you through an example of how to use a pre-built Couchbase Lite database. We looked at a simple Query example. Check out the following links for further details on the Query API including a Xcode playground for testing the APIs.

=== Further Reading
* link:https://blog.couchbase.com/xcode-playground-couchbase-mobile/[Xcode Playground For Couchbase Lite 2.0]

* link:https://blog.couchbase.com/sql-for-json-query-interface-couchbase-mobile/[Fundamentals of the Couchbase Lite 2.0 Query API]

* link:https://blog.couchbase.com/querying-array-collections-couchbase-mobile/[Handling Arrays in Queries]

* link:https://blog.couchbase.com/full-text-search-couchbase-mobile-2-0/[Couchbase Lite 2.0 Full Text Search API]

* link:https://blog.couchbase.com/join-queries-couchbase-mobile/[Couchbase Lite 2.0 JOIN Query]
